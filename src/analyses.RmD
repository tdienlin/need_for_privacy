---
title: "Who Needs Privacy?"
subtitle: "Analyses"
output:
  pdf_document: default
---

```{r knitr-setup, include=F}
knitr::opts_chunk$set(warning=F, echo=F)
options(digits = 3)
```

```{r r-setup, include=F, echo=F}
# list packages to be used
packages <- c("devtools", "lavaan", "MBESS", "magrittr", "psych", "semPlot", "tidyverse")

# install packages
install <- FALSE  # change to TRUE to install packages
if(isTRUE(install)) (
  lapply(packages, install.packages, repos = 'http://cran.us.r-project.org')
)
# devtools::install_git("https://github.com/tdienlin/td")

# load packages
lapply(packages, library, character.only = TRUE)
library(td)
```

```{r data-wrangling, include=F, echo=F}
# read data
# note: a bit complicated, as second row contains variable attributes
d <- read_csv("../data/data.csv", skip = 2, col_names = FALSE) %>% 
  set_names(colnames(read_csv("../data/data.csv", n_max = 1)))

# prepare table with item content
items <- data.frame(
  name = colnames(read_csv("../data/data.csv", n_max = 1)),  # extract item names
  content = colnames(read_csv("../data/data.csv", skip = 1, n_max = 2))  # extract item content
) %>% 
  mutate(content = gsub("To what extent do you agree or disagree with the following / statements[?][-]", "", content)) %>% 
  mutate(content = gsub("To what extent do you agree or disagree with the / following statements[?][-]", "", content)) %>% 
  mutate(content_breaks = sapply(content, string_break, 30))

# filter pretest data
d <- d[-(1:11), ]

# recode
d <- d %>% 
  mutate_at(vars(RIT_1:RIT_8), funs(as.numeric(.)))
```

# Measures
## Need for Privacy

```{r, fig.height=15, fig.width=12}
d_tmp <- select(d, starts_with("N4P"))
name_tmp <- "pri_nee"
recoded_tmp <- c("N4P.INT_1", "N4P.INT_5", "N4P.INT_8")

ggplot(d_tmp %>% 
         gather(name, value) %>% 
         left_join(items, "name"),
         aes(x = value)) +
  geom_bar() +
  facet_wrap(~content_breaks)

# recode
d[recoded_tmp] <- 8 - d[recoded_tmp]
d_tmp <- select(d, starts_with("N4P"))  # new selection bc of recoding
```

### Parallel analysis

```{r}
fa.parallel(d_tmp)
```

Solution suggests 4 or 3 factors

### EFA 4 factors

```{r}
tmp <- omega(d_tmp, nfactors = 4, fm = "ml")
```

Shows several items with negative or low loadings, which will be excluded in updated version.

\newpage

```{r}
tmp <- omega(select(d_tmp, 
                    -N4P.BOT_4, -N4P.BOT_3, -N4P.SOC_7, -N4P.INT_5, -N4P.INT_3), 
             nfactors = 4, fm = "ml")
```

Produces a fitting solution.

\newpage

```{r}
tmp$schmid$sl
```

Using four factors, looking at the items's content we do not find an easily interpretable solution.

\newpage
### EFA 3 factors

```{r}
tmp <- omega(d_tmp, nfactors = 3, fm = "ml")
```

Shows several items with negative or low loadings, which will be excluded in updated version.


\newpage

```{r}
tmp <- omega(select(d_tmp,
                    -N4P.BOT_4, -N4P.BOT_3, -N4P.INT_5, -N4P.INT_3, -N4P.INT_7, -N4P.INT_4), 
             nfactors = 3, fm = "ml")
```

Produces a fitting solution.

\newpage

```{r}
tmp$schmid$sl
```

Interpretation

* factor 1 measures privacy from the government (vertical)
* factor 2 measures privacy from identification (combined)
* factor 3 measures privacy from other people (horizontal)

### CFA

```{r}
model <- '
  pri_nee_ver =~ N4P.SOC_4 + N4P.SOC_1 + N4P.SOC_3 + N4P.SOC_9 + N4P.SOC_2 + N4P.SOC_5
  pri_nee_ide =~ N4P.INT_1 + N4P.SOC_7 + N4P.SOC_8 + N4P.INT_8 + N4P.SOC_6 + N4P.INT_2 + N4P.INT_6 
  pri_nee_hor =~ N4P.BOT_1 + N4P.BOT_2 + N4P.INT_6 + N4P.INT_9 + N4P.INT_2
  pri_nee_gen =~ N4P.SOC_4 + N4P.SOC_1 + N4P.SOC_3 + N4P.SOC_9 + N4P.SOC_2 + N4P.SOC_5 + N4P.INT_1 + N4P.SOC_7 + N4P.SOC_8 + N4P.INT_8 + N4P.SOC_6 + N4P.INT_2 + N4P.INT_6 + N4P.BOT_1 + N4P.BOT_2 + N4P.INT_6 + N4P.INT_9 + N4P.INT_2
  pri_nee_gen ~~ 0*pri_nee_ver + 0*pri_nee_hor + 0*pri_nee_ide
  pri_nee_ver ~~ 0*pri_nee_hor + 0*pri_nee_ide
  pri_nee_hor ~~ 0*pri_nee_ide
'
fit <- cfa(model, d, missing = "ml")
summary(fit, fit = TRUE, std = TRUE)
assign(paste0(name_tmp, "_fit"), cfa(model, d))
semPaths(fit, bifactor = "pri_nee_gen", layout = "tree3")
```

\newpage
## Integrity

```{r, fig.height=8, fig.width=12}
d_tmp <- select(d, starts_with("INT_"))
name_tmp <- "int"
recoded_tmp <- c("INT_1", "INT_2", "INT_5", "INT_6", "INT_7", 
                 "INT_8", "INT_9", "INT_10", "INT_11")

ggplot(d_tmp %>% 
         gather(name, value) %>% 
         left_join(items, "name"),
         aes(x = value)) +
  geom_bar() +
  facet_wrap(~content_breaks)

# recode
d[recoded_tmp] <- 8 - d[recoded_tmp]
d_tmp <- select(d, starts_with("INT_"))  # new selection bc of recoding
```

### Parallel analysis

```{r}
fa.parallel(d_tmp)
```

### EFA

```{r}
tmp <- omega(d_tmp, fm = "ml", nfactors = 3)
```

Shows no clear solution for three factors.

\newpage

```{r}
tmp <- omega(d_tmp, fm = "ml", nfactors = 2)
```

Shows solution for two factors. Delete items INT_4 and INT_3 for not loading on general factor

\newpage

```{r}
tmp <- omega(select(d_tmp, -INT_3, -INT_4), fm = "ml", nfactors = 2)
```

\newpage

```{r}
tmp$schmid$sl
```

Interpretation

* factor 1 measures ...
* factor 2 measures ...

### CFA

```{r}
model <- '
  int_1 =~ INT_1 + INT_2 + a*INT_5 + a*INT_6 + a*INT_7 + INT_8
  int_2 =~ b*INT_8 + b*INT_9 + b*INT_10 + b*INT_11
  int_gen =~ INT_1 + INT_2 + INT_5 + INT_6 + INT_7 + INT_8 + INT_9 + INT_10 + INT_11
  int_gen ~~ 0*int_1 + 0*int_2
  int_1 ~~ 0*int_2
'
fit <- cfa(model, d, missing = "ml")
summary(fit, fit = TRUE, std = TRUE)
assign(paste0(name_tmp, "_fit"), 
       cfa(model, d))
assign(paste0(name_tmp, "_gen"), 
       select(as.data.frame(predict(fit)), ends_with("_gen")))
```

## Sociability

```{r, fig.height=8, fig.width=12}
d_tmp <- select(d, SOC_1 : SOC_8)
name_tmp <- "soc"
recoded_tmp <- c("SOC_1", "SOC_3", "SOC_5", "SOC_7")

p_int <- ggplot(d_tmp %>% 
                  gather(name, value) %>% 
                  left_join(items, "name"),
                  aes(x = value)) +
  geom_bar() +
  facet_wrap(~content_breaks)
p_int

# recode
d[recoded_tmp] <- 8 - d[recoded_tmp]
d_tmp <- select(d, SOC_1 : SOC_8)  # new selection bc of recoding
```

### Parallel analysis

```{r}
fa.parallel(d_tmp)
```

\newpage

### EFA

```{r}
tmp <- omega(d_tmp, fm = "ml", nfactors = 3)
```

Shows no clear solution for three factors.

\newpage

```{r}
tmp <- omega(d_tmp, fm = "ml", nfactors = 2)
```

Shows solution for two factors. Differentiates between inverted and regular items. 

\newpage

```{r}
tmp$schmid$sl
```

Interpretation

* factor 1 measures ...
* factor 2 measures ...

### CFA

```{r}
model <- '
  soc_1 =~ a*SOC_1 + SOC_3 + SOC_5 + a*SOC_7
  soc_2 =~ b*SOC_2 + SOC_4 + SOC_6 + b*SOC_8 + SOC_1 + SOC_7
  soc_gen =~ SOC_1 + SOC_2 + SOC_3 + SOC_4 + SOC_5 + SOC_6 + SOC_7 + SOC_8
  soc_gen ~~ 0*soc_1 + 0*soc_2
  soc_1 ~~ 0*soc_2
'
fit <- cfa(model, d, missing = "ml")
summary(fit, fit = TRUE, std = TRUE)
assign(paste0(name_tmp, "_fit"), 
       cfa(model, d))
assign(paste0(name_tmp, "_gen"), 
       select(as.data.frame(predict(fit)), ends_with("_gen")))
```

## Fearfulness

```{r}
d_tmp <- select(d, starts_with("FEA_"))
name_tmp <- "fea"
recoded_tmp <- c("FEA_1", "FEA_3", "FEA_5", "FEA_7")

ggplot(d_tmp %>% 
         gather(name, value) %>% 
         left_join(items, "name"),
         aes(x = value)) +
  geom_bar() +
  facet_wrap(~content_breaks)

# recode
d[recoded_tmp] <- 8 - d[recoded_tmp]
d_tmp <- select(d, starts_with("FEA_"))  # new selection bc of recoding
```

### Parallel analysis

```{r}
fa.parallel(d_tmp)
```

### EFA 4 factors

```{r}
tmp <- omega(d_tmp, nfactors = 2, fm = "ml")
```

Produces a fitting solution.

\newpage

```{r}
tmp$schmid$sl
```

\newpage
### CFA

```{r}
model <- '
  fea_1 =~ a*FEA_2 + a*FEA_4 + a*FEA_6 + FEA_8
  fea_2 =~ FEA_1 + b*FEA_3 + b*FEA_5 + b*FEA_7
  fea_gen =~ FEA_2 + FEA_4 + FEA_7 + FEA_8 + FEA_1 + FEA_3 + FEA_5 + FEA_6
  
  fea_gen ~~ 0*fea_1 + 0*fea_2
  fea_1 ~~ 0*fea_2
'
fit <- cfa(model, d, missing = "ml")
summary(fit, fit = TRUE, std = TRUE)
assign(paste0(name_tmp, "_fit"), cfa(model, d))
assign(paste0(name_tmp, "_gen"), 
       select(as.data.frame(predict(fit)), ends_with("_gen")))
```

\newpage

## Traditionalism

```{r}
d_tmp <- select(d, TRA_1 : TRA_8)
name_tmp <- "tra"
recoded_tmp <- c("TRA_2", "TRA_4", "TRA_6")

ggplot(d_tmp %>% 
         gather(name, value) %>% 
         left_join(items, "name"),
         aes(x = value)) +
  geom_bar() +
  facet_wrap(~content_breaks)

# recode
d[recoded_tmp] <- 8 - d[recoded_tmp]
d_tmp <- select(d, TRA_1 : TRA_8)  # new selection bc of recoding
```

### Parallel analysis

```{r}
fa.parallel(d_tmp)
```

### EFA 4 factors

```{r}
tmp <- omega(d_tmp, nfactors = 2, fm = "ml")
```

Produces a fitting solution.

\newpage

```{r}
tmp$schmid$sl
```

\newpage
### CFA

```{r}
model <- '
  tra_1 =~ a*TRA_1 + a*TRA_3 + a*TRA_5 + a*TRA_7 + a*TRA_8
  tra_2 =~ TRA_2 + TRA_4 + TRA_6 
  tra_gen =~ TRA_1 + TRA_2 + TRA_3 + TRA_4 + TRA_5 + TRA_6 + TRA_7 + TRA_8
  
  tra_gen ~~ 0*tra_1 + 0*tra_2
  tra_1 ~~ 0*tra_2
'
fit <- cfa(model, d, missing = "ml")
summary(fit, fit = TRUE, std = TRUE)
assign(paste0(name_tmp, "_fit"), cfa(model, d))
assign(paste0(name_tmp, "_gen"), 
       select(as.data.frame(predict(fit)), ends_with("_gen")))
```

\newpage

## Risk Avoidance

```{r}
d_tmp <- select(d, RIT_1 : RIT_8)
name_tmp <- "rit"
recoded_tmp <- c("RIT_1", "RIT_3", "RIT_5")
  
ggplot(d_tmp %>% 
         gather(name, value) %>% 
         left_join(items, "name"),
         aes(x = value)) +
  geom_bar() +
  facet_wrap(~content_breaks)

# recode
d[recoded_tmp] <- 8 - d[recoded_tmp]
d_tmp <- select(d, RIT_1 : RIT_8)  # new selection bc of recoding
```

### Parallel analysis

```{r}
fa.parallel(d_tmp)
```

### EFA 4 factors

```{r}
tmp <- omega(d_tmp, nfactors = 2, fm = "ml")
```

Produces a fitting solution.

\newpage

```{r}
tmp$schmid$sl
```

\newpage
### CFA

```{r}
model <- '
  rit_1 =~ a*RIT_2 + a*RIT_4 + a*RIT_5 + a*RIT_7 + a*RIT_8
  rit_2 =~ RIT_1 + RIT_3 + RIT_5
  rit_gen =~ RIT_1 + RIT_2 + RIT_3 + RIT_4 + RIT_5 + RIT_6 + RIT_7 + RIT_8
  
  rit_gen ~~ 0*rit_1 + 0*rit_2
  rit_1 ~~ 0*rit_2
'
fit <- cfa(model, d, missing = "ml")
summary(fit, fit = TRUE, std = TRUE)
assign(paste0(name_tmp, "_fit"), cfa(model, d))
assign(paste0(name_tmp, "_gen"), 
       select(as.data.frame(predict(fit)), ends_with("_gen")))
```

## Big five

```{r}
d_tmp <- select(d, BFI_1 : BFI_10)
name_tmp <- "BFI"

ggplot(d_tmp %>% 
         gather(name, value) %>% 
         left_join(items, "name"),
         aes(x = value)) +
  geom_bar() +
  facet_wrap(~content_breaks)
```

### Correlations

```{r}
cor(d_tmp, use = "pairwise.complete.obs")
```

The dimensions show low correlations; as a result, we will use only 1 item (the one which is not inverted), to measure each dimension. This includes the following items: 

* BFI_2, BFI_3, BFI_5, BFI_8, BFI_9

# Results

```{r}
d <- cbind(d, int_gen, soc_gen, fea_gen, tra_gen, rit_gen)
```

```{r}
name_tmp <- "main"
model <- '
  pri_nee_ver =~ N4P.SOC_4 + N4P.SOC_1 + N4P.SOC_3 + N4P.SOC_9 + N4P.SOC_2 + N4P.SOC_5
  pri_nee_ide =~ N4P.INT_1 + N4P.SOC_7 + N4P.SOC_8 + N4P.INT_8 + N4P.SOC_6 + N4P.INT_2 + N4P.INT_6 
  pri_nee_hor =~ N4P.BOT_1 + N4P.BOT_2 + N4P.INT_6 + N4P.INT_9 + N4P.INT_2
  pri_nee_gen =~ N4P.SOC_4 + N4P.SOC_1 + N4P.SOC_3 + N4P.SOC_9 + N4P.SOC_2 + N4P.SOC_5 + N4P.INT_1 + N4P.SOC_7 + N4P.SOC_8 + N4P.INT_8 + N4P.SOC_6 + N4P.INT_2 + N4P.INT_6 + N4P.BOT_1 + N4P.BOT_2 + N4P.INT_6 + N4P.INT_9 + N4P.INT_2
  
  pri_nee_gen ~ int_gen + soc_gen + fea_gen + tra_gen + rit_gen
  pri_nee_ver ~ int_gen + soc_gen + fea_gen + tra_gen + rit_gen
  pri_nee_ide ~ int_gen + soc_gen + fea_gen + tra_gen + rit_gen
  pri_nee_hor ~ int_gen + soc_gen + fea_gen + tra_gen + rit_gen

  int_gen ~~ soc_gen + fea_gen + tra_gen + rit_gen
  soc_gen ~~ fea_gen + tra_gen + rit_gen
  fea_gen ~~ tra_gen + rit_gen
  tra_gen ~~ rit_gen

  pri_nee_gen ~~ 0*pri_nee_ver + 0*pri_nee_hor + 0*pri_nee_ide
  pri_nee_ver ~~ 0*pri_nee_hor + 0*pri_nee_ide
  pri_nee_hor ~~ 0*pri_nee_ide
'
fit <- sem(model, d, missing = "ml")
summary(fit, fit = TRUE, std = TRUE)
assign(paste0(name_tmp, "_fit"), cfa(model, d))
```

## With big five

```{r}
name_tmp <- "main_bigfive"
model <- '
  pri_nee_ver =~ N4P.SOC_4 + N4P.SOC_1 + N4P.SOC_3 + N4P.SOC_9 + N4P.SOC_2 + N4P.SOC_5
  pri_nee_ide =~ N4P.INT_1 + N4P.SOC_7 + N4P.SOC_8 + N4P.INT_8 + N4P.SOC_6 + N4P.INT_2 + N4P.INT_6 
  pri_nee_hor =~ N4P.BOT_1 + N4P.BOT_2 + N4P.INT_6 + N4P.INT_9 + N4P.INT_2
  pri_nee_gen =~ N4P.SOC_4 + N4P.SOC_1 + N4P.SOC_3 + N4P.SOC_9 + N4P.SOC_2 + N4P.SOC_5 + N4P.INT_1 + N4P.SOC_7 + N4P.SOC_8 + N4P.INT_8 + N4P.SOC_6 + N4P.INT_2 + N4P.INT_6 + N4P.BOT_1 + N4P.BOT_2 + N4P.INT_6 + N4P.INT_9 + N4P.INT_2

  pri_nee_gen ~ int_gen + soc_gen + fea_gen + tra_gen + rit_gen + BFI_2 + BFI_3 + BFI_5 + BFI_8 + BFI_9
  pri_nee_ver ~ int_gen + soc_gen + fea_gen + tra_gen + rit_gen + BFI_2 + BFI_3 + BFI_5 + BFI_8 + BFI_9
  pri_nee_ide ~ int_gen + soc_gen + fea_gen + tra_gen + rit_gen + BFI_2 + BFI_3 + BFI_5 + BFI_8 + BFI_9
  pri_nee_hor ~ int_gen + soc_gen + fea_gen + tra_gen + rit_gen + BFI_2 + BFI_3 + BFI_5 + BFI_8 + BFI_9

  int_gen ~~ soc_gen + fea_gen + tra_gen + rit_gen + BFI_2 + BFI_3 + BFI_5 + BFI_8 + BFI_9
  soc_gen ~~ fea_gen + tra_gen + rit_gen + BFI_2 + BFI_3 + BFI_5 + BFI_8 + BFI_9
  fea_gen ~~ tra_gen + rit_gen + BFI_2 + BFI_3 + BFI_5 + BFI_8 + BFI_9
  tra_gen ~~ rit_gen + BFI_2 + BFI_3 + BFI_5 + BFI_8 + BFI_9
  rit_gen ~~ BFI_2 + BFI_3 + BFI_5 + BFI_8 + BFI_9
  BFI_2 ~~ BFI_3 + BFI_5 + BFI_8 + BFI_9
  BFI_3 ~~ BFI_5 + BFI_8 + BFI_9
  BFI_5 ~~ BFI_8 + BFI_9
  BFI_8 ~~ BFI_9

  pri_nee_gen ~~ 0*pri_nee_ver + 0*pri_nee_hor + 0*pri_nee_ide
  pri_nee_ver ~~ 0*pri_nee_hor + 0*pri_nee_ide
  pri_nee_hor ~~ 0*pri_nee_ide
'
fit <- sem(model, d, missing = "ml")
summary(fit, fit = TRUE, std = TRUE)
```


# Visualization

```{r}
d_effects <- coeffs_tab(main_fit) %>%
  mutate(sig = ifelse(p < .05, "1", "0"))

std_ci <- ci.src(beta.k = d_effects$beta, b.k = d_effects$b, 
                 N = 400, conf.level = .95, SE.b.k = .10, s.Y = sqrt(.955), )
  
p_effects <- ggplot(d_effects, aes(x = beta)) +
  geom_point(aes(y = Predictor, color = sig)) +
  scale_color_manual(values = c("#000000", "#FF0000")) +
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = 0.1, linetype = "dashed") +
  geom_vline(xintercept = -0.1, linetype = "dashed") +
  theme_bw() + 
  facet_grid(~ Outcome)
```

